<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SALAHELDIN DASHBOARD â€” Advanced</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#090b0f;--card:#12151c;--blue:#3067ff;--green:#26a69a;--red:#ef5350;--text:#e0e0e0}
*{box-sizing:border-box}
body{margin:0;font-family:sans-serif;direction:rtl;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--card);border-bottom:1px solid #162033}
.header b{font-size:18px;letter-spacing:1px;color:var(--blue)}
.header small{color:#9aa3b2}
.container{max-width:1200px;margin:18px auto;padding:0 12px}
.controls{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.controls .field{background:var(--card);padding:10px;border-radius:10px;border:1px solid #1e222d}
.controls input, .controls select{background:transparent;border:none;color:var(--text);outline:none}
.controls label{display:block;color:#9aa3b2;font-size:12px;margin-bottom:6px}
.dashboard{display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;margin-bottom:12px}
.stat-card{background:var(--card);padding:12px;border-radius:10px;text-align:center;border:1px solid #1e222d}
.stat-card h4{margin:0;font-size:11px;color:#8891a0;text-transform:uppercase}
.stat-card b{font-size:18px;display:block;margin-top:6px}
.main-chart{background:var(--card);padding:12px;border-radius:12px;border:1px solid #1e222d;margin-bottom:12px}
.form-section{background:var(--card);padding:16px;border-radius:12px;margin-bottom:12px;border:1px solid #1e222d}
.input-row{display:flex;gap:10px}
.input-row .col{flex:1}
input, select, textarea, button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #2a2e39;background:#1e222d;color:#fff;font-size:14px}
textarea{height:70px;resize:vertical}
button{background:var(--blue);border:none;font-weight:700;cursor:pointer;transition:0.2s}
button:hover{opacity:0.9}
.trades-list{overflow-x:auto;background:transparent;padding-bottom:20px}
table{width:100%;border-collapse:collapse;background:transparent;font-size:13px}
th, td{padding:10px;text-align:center;border-bottom:1px solid #1e222d;white-space:nowrap}
.win{color:var(--green)} .loss{color:var(--red)}
.note-text{font-size:12px;color:#aaa;max-width:220px;display:inline-block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.actions{display:flex;gap:8px;justify-content:center}
.tag{padding:6px 8px;border-radius:8px;background:#11131a;border:1px solid #22262f;color:#bfc9d8;font-size:12px}
.small-btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
.del{background:#2b0f12;color:#fff}
.export{background:#0b3b22}
.meta{font-size:12px;color:#9aa3b2;margin-top:6px}
.filter-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}

/* modal */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:30;visibility:hidden;opacity:0;transition:0.15s}
.modal.show{visibility:visible;opacity:1}
.modal .card{width:100%;max-width:720px;background:var(--card);padding:16px;border-radius:10px;border:1px solid #22262f}

/* responsive */
@media (max-width:1000px){
  .dashboard{grid-template-columns:repeat(2,1fr)}
}
@media (max-width:600px){
  .dashboard{grid-template-columns:repeat(1,1fr)}
  .input-row{flex-direction:column}
  th, td{font-size:12px;padding:8px}
  .controls{gap:6px}
}
</style>
</head>
<body>
<div class="header">
  <b>SALAHELDIN DASHBOARD ğŸš€</b>
  <small>Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø© â€” Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø§Øª</small>
</div>

<div class="container">

  <div class="controls">
    <div class="field">
      <label>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ (Start Capital $)</label>
      <input id="startCapital" type="number" step="any" value="10000" />
    </div>

    <div class="field">
      <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø£ØµÙ„</label>
      <input id="searchAsset" placeholder="Ù…Ø«Ù„Ø§Ù‹: BTC Ø£Ùˆ Ø°Ù‡Ø¨" />
    </div>

    <div class="field">
      <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
      <input id="filterFrom" type="date" />
    </div>

    <div class="field">
      <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
      <input id="filterTo" type="date" />
    </div>

    <div class="field" style="display:flex;align-items:center;">
      <button id="applyFilter" class="small-btn" style="background:#264653">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
      <button id="clearFilter" class="small-btn" style="background:#6c757d;margin-left:6px">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
    </div>

    <div style="margin-inline-start:auto" class="field">
      <label>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</label>
      <div style="display:flex;gap:8px">
        <button id="exportBtn" class="small-btn export">ØªØµØ¯ÙŠØ± CSV</button>
        <button id="clearBtn" class="small-btn del">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>
    </div>
  </div>

  <div class="dashboard" role="region" aria-label="Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">
    <div class="stat-card"><h4>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª</h4><b id="tCount">0</b></div>
    <div class="stat-card"><h4>Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</h4><b id="winRate" class="win">0%</b></div>
    <div class="stat-card"><h4>ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ($)</h4><b id="net">$0.00</b></div>
    <div class="stat-card"><h4>Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¨Ø­ (Profit Factor)</h4><b id="pf">0.0</b></div>

    <div class="stat-card"><h4>Max Drawdown ($)</h4><b id="maxDD">-$0.00</b></div>
    <div class="stat-card"><h4>CAGR (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</h4><b id="cagr">0.0%</b></div>
    <div class="stat-card"><h4>Average Win / Loss</h4><b id="avgWL">$0 / $0</b></div>
    <div class="stat-card"><h4>Expectancy</h4><b id="expectancy">$0.00</b></div>
  </div>

  <div class="main-chart" aria-hidden="false">
    <canvas id="equityChart" height="160"></canvas>
    <div class="meta">Equity (Ø²Ø±Ù‚Ø§Ø¡) Ùˆ Drawdown (Ø­Ù…Ø±Ø§Ø¡)</div>
  </div>

  <div class="form-section" aria-label="Ø¥Ø¶Ø§ÙØ© ØµÙÙ‚Ø©">
    <h3>â• Ø¥Ø¶Ø§ÙØ© / Ø¥Ø¯Ø®Ø§Ù„ ØµÙÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <div class="input-row">
      <div class="col"><input id="asset" placeholder="Ø§Ù„Ø£ØµÙ„ (Ù…Ø«Ù„Ø§Ù‹: BTC, Ø°Ù‡Ø¨, TSLA)"></div>
      <div style="width:140px">
        <select id="type">
          <option value="buy">Ø´Ø±Ø§Ø¡ (Long)</option>
          <option value="sell">Ø¨ÙŠØ¹ (Short)</option>
        </select>
      </div>
    </div>

    <div class="input-row">
      <div class="col"><input id="entry" type="number" step="any" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„"></div>
      <div class="col"><input id="stop" type="number" step="any" placeholder="Ø³Ø¹Ø± ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© (Stop)"></div>
      <div class="col"><input id="exit" type="number" step="any" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø®Ø±ÙˆØ¬/Ø§Ù„Ù‡Ø¯Ù"></div>
    </div>

    <div class="input-row">
      <div class="col"><input id="risk" type="number" step="any" placeholder="Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± ($)"></div>
      <div style="width:160px"><input id="date" type="date" /></div>
    </div>

    <textarea id="note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØµÙÙ‚Ø© (Ù„Ù…Ø§Ø°Ø§ Ø¯Ø®Ù„ØªØŸ)"></textarea>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="saveBtn">Ø­ÙØ¸ Ø§Ù„ØµÙÙ‚Ø©</button>
      <button id="addSample" class="small-btn" style="background:#2a6f3c">Ø£Ø¶Ù Ù…Ø«Ø§Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
    </div>
  </div>

  <div class="trades-list" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙ‚Ø§Øª">
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø²Ù…Ù†</th>
          <th>Ø§Ù„Ø£ØµÙ„</th>
          <th>Ù†ÙˆØ¹</th>
          <th>Ø¯Ø®ÙˆÙ„</th>
          <th>ÙˆÙ‚Ù</th>
          <th>Ø®Ø±ÙˆØ¬</th>
          <th>Ø­Ø¬Ù…</th>
          <th>Ù†ØªÙŠØ¬Ø© ($)</th>
          <th>R:R</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<!-- Edit Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="card">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø©</h3>
    <div class="input-row">
      <div class="col"><input id="m_asset" placeholder="Ø§Ù„Ø£ØµÙ„"></div>
      <div style="width:140px">
        <select id="m_type"><option value="buy">Ø´Ø±Ø§Ø¡</option><option value="sell">Ø¨ÙŠØ¹</option></select>
      </div>
    </div>
    <div class="input-row">
      <div class="col"><input id="m_entry" type="number" step="any" placeholder="Ø³Ø¹Ø± Ø¯Ø®ÙˆÙ„"></div>
      <div class="col"><input id="m_stop" type="number" step="any" placeholder="ÙˆÙ‚Ù"></div>
      <div class="col"><input id="m_exit" type="number" step="any" placeholder="Ø³Ø¹Ø± Ø®Ø±ÙˆØ¬"></div>
    </div>
    <div class="input-row">
      <div class="col"><input id="m_risk" type="number" step="any" placeholder="Ù…Ø®Ø§Ø·Ø±Ø© $"></div>
      <div style="width:160px"><input id="m_date" type="date" /></div>
    </div>
    <textarea id="m_note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="saveEdit" class="small-btn" style="background:#2266ff">Ø­ÙØ¸</button>
      <button id="closeModal" class="small-btn" style="background:#6c757d">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
// Storage key
const STORAGE_KEY = "salaheldin_db_v3";

// DOM
const startCapitalEl = document.getElementById("startCapital");
const searchAsset = document.getElementById("searchAsset");
const filterFrom = document.getElementById("filterFrom");
const filterTo = document.getElementById("filterTo");
const applyFilter = document.getElementById("applyFilter");
const clearFilter = document.getElementById("clearFilter");

const asset = document.getElementById("asset");
const type = document.getElementById("type");
const entry = document.getElementById("entry");
const exitP = document.getElementById("exit");
const stop = document.getElementById("stop");
const risk = document.getElementById("risk");
const note = document.getElementById("note");
const dateInput = document.getElementById("date");

const rows = document.getElementById("rows");
const tCount = document.getElementById("tCount");
const winRate = document.getElementById("winRate");
const pf = document.getElementById("pf");
const netEl = document.getElementById("net");
const maxDDEl = document.getElementById("maxDD");
const cagrEl = document.getElementById("cagr");
const avgWLEl = document.getElementById("avgWL");
const expectancyEl = document.getElementById("expectancy");

const saveBtn = document.getElementById("saveBtn");
const clearBtn = document.getElementById("clearBtn");
const exportBtn = document.getElementById("exportBtn");
const addSample = document.getElementById("addSample");

const modal = document.getElementById("modal");
const m_asset = document.getElementById("m_asset");
const m_type = document.getElementById("m_type");
const m_entry = document.getElementById("m_entry");
const m_exit = document.getElementById("m_exit");
const m_stop = document.getElementById("m_stop");
const m_risk = document.getElementById("m_risk");
const m_note = document.getElementById("m_note");
const m_date = document.getElementById("m_date");
const saveEdit = document.getElementById("saveEdit");
const closeModal = document.getElementById("closeModal");

// state
let trades = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let chart;
let editId = null;
let activeFilters = { asset: "", from: null, to: null };

// helpers
const fmt = num => Number(num).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

// add trade
function addTrade(){
  const a = asset.value.trim();
  const t = type.value;
  const e = parseFloat(entry.value);
  const x = parseFloat(exitP.value);
  const s = parseFloat(stop.value);
  const r = parseFloat(risk.value);
  const n = note.value.trim();
  const d = dateInput.value;

  if(!a || isNaN(e) || isNaN(x) || isNaN(s) || isNaN(r) || r <= 0) {
    return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø±Ø© Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±).");
  }
  const stopDist = Math.abs(e - s);
  if(stopDist === 0) return alert("Ù…Ø³Ø§ÙØ© ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† ØµÙØ±.");

  const positionSize = r / stopDist;
  const pnlPerUnit = (t === "buy") ? (x - e) : (e - x);
  const profitUSD = pnlPerUnit * positionSize;
  const rr = profitUSD / r;

  const trade = {
    id: uid(),
    asset: a,
    type: t,
    entry: e,
    stop: s,
    exit: x,
    risk: r,
    positionSize: Number(positionSize.toFixed(4)),
    pnl: Number(profitUSD.toFixed(2)),
    rr: Number(rr.toFixed(2)),
    note: n || "Ø¨Ø¯ÙˆÙ† Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
    created_at: d ? new Date(d).toISOString() : new Date().toISOString()
  };

  trades.push(trade);
  persist();
  clearForm();
  render();
}

function clearForm(){
  asset.value=""; entry.value=""; exitP.value=""; stop.value=""; risk.value=""; note.value=""; dateInput.value="";
}

// persist
function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(trades)); }

// delete
function deleteTrade(id){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØµÙÙ‚Ø©ØŸ")) return;
  trades = trades.filter(t=>t.id !== id);
  persist(); render();
}

// edit
function openEdit(id){
  const t = trades.find(x=>x.id===id);
  if(!t) return;
  editId = id;
  m_asset.value = t.asset;
  m_type.value = t.type;
  m_entry.value = t.entry;
  m_stop.value = t.stop;
  m_exit.value = t.exit;
  m_risk.value = t.risk;
  m_note.value = t.note;
  m_date.value = new Date(t.created_at).toISOString().slice(0,10);
  modal.classList.add("show");
}
function closeEdit(){ modal.classList.remove("show"); editId = null; }
function saveEditTrade(){
  if(!editId) return;
  const a = m_asset.value.trim();
  const t = m_type.value;
  const e = parseFloat(m_entry.value);
  const x = parseFloat(m_exit.value);
  const s = parseFloat(m_stop.value);
  const r = parseFloat(m_risk.value);
  const n = m_note.value.trim();
  const d = m_date.value;
  if(!a || isNaN(e) || isNaN(x) || isNaN(s) || isNaN(r) || r <= 0) {
    return alert("ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.");
  }
  const stopDist = Math.abs(e - s);
  if(stopDist === 0) return alert("Ù…Ø³Ø§ÙØ© ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† ØµÙØ±.");

  const positionSize = r / stopDist;
  const pnlPerUnit = (t === "buy") ? (x - e) : (e - x);
  const profitUSD = pnlPerUnit * positionSize;
  const rr = profitUSD / r;

  trades = trades.map(tr => {
    if(tr.id !== editId) return tr;
    return {
      ...tr,
      asset: a, type: t, entry: e, stop: s, exit: x,
      risk: r, positionSize: Number(positionSize.toFixed(4)),
      pnl: Number(profitUSD.toFixed(2)), rr: Number(rr.toFixed(2)),
      note: n || "Ø¨Ø¯ÙˆÙ† Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
      created_at: d ? new Date(d).toISOString() : new Date().toISOString()
    };
  });
  persist(); closeEdit(); render();
}

// clear all
function clearAll(){
  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) return;
  trades = [];
  persist(); render();
}

// export CSV
function exportCSV(){
  if(trades.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.");
  const headers = ["created_at","asset","type","entry","stop","exit","risk","positionSize","pnl","rr","note"];
  const rowsCSV = trades.map(t => headers.map(h => `"${String(t[h] ?? "")}"`).join(","));
  const csv = [headers.join(","), ...rowsCSV].join("\n");
  const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `salaheldin_trades_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// filters
function applyFilters(){
  activeFilters.asset = searchAsset.value.trim().toLowerCase();
  activeFilters.from = filterFrom.value ? new Date(filterFrom.value) : null;
  activeFilters.to = filterTo.value ? new Date(filterTo.value) : null;
  render();
}
function clearFilters(){
  searchAsset.value=""; filterFrom.value=""; filterTo.value="";
  activeFilters = { asset: "", from: null, to: null };
  render();
}

// statistics calculations
function calcStats(filteredTrades, startCapital){
  const stats = {
    total: filteredTrades.length,
    wins:0, losses:0, net:0, gWin:0, gLoss:0,
    avgWin:0, avgLoss:0, largestWin:0, largestLoss:0,
    expectancy:0, profitFactor:0,
    equitySeries: [startCapital], ddSeries:[0], maxDrawdown:0,
    cagr:0, consecWin:0, consecLoss:0
  };

  let peak = startCapital;
  let equity = startCapital;
  let currentWinStreak = 0, currentLossStreak = 0, maxWinStreak = 0, maxLossStreak = 0;

  filteredTrades.forEach(t=>{
    stats.net += t.pnl;
    if(t.pnl > 0){ stats.wins++; stats.gWin += t.pnl; currentWinStreak++; currentLossStreak=0; }
    else { stats.losses++; stats.gLoss += Math.abs(t.pnl); currentLossStreak++; currentWinStreak=0; }
    if(currentWinStreak > maxWinStreak) maxWinStreak = currentWinStreak;
    if(currentLossStreak > maxLossStreak) maxLossStreak = currentLossStreak;

    stats.largestWin = Math.max(stats.largestWin, t.pnl);
    stats.largestLoss = Math.min(stats.largestLoss, t.pnl);

    equity += t.pnl;
    stats.equitySeries.push(Number(equity.toFixed(2)));
    if(equity > peak) peak = equity;
    let dd = equity - peak; // negative or 0
    stats.ddSeries.push(Number(dd.toFixed(2)));
    stats.maxDrawdown = Math.min(stats.maxDrawdown, dd);
  });

  stats.avgWin = stats.wins ? (stats.gWin / stats.wins) : 0;
  stats.avgLoss = stats.losses ? (stats.gLoss / stats.losses) : 0;
  stats.profitFactor = stats.gLoss > 0 ? (stats.gWin / stats.gLoss) : (stats.gWin > 0 ? stats.gWin : 0);
  stats.expectancy = ( (stats.avgWin * (stats.wins / Math.max(1, stats.total))) - (stats.avgLoss * (stats.losses / Math.max(1, stats.total))) ).toFixed(2);

  // streaks
  stats.maxWinStreak = maxWinStreak;
  stats.maxLossStreak = maxLossStreak;

  // CAGR calculation (approx): based on first and last trade dates
  let cagr = 0;
  if(filteredTrades.length > 0){
    const dates = filteredTrades.map(t=>new Date(t.created_at)).sort((a,b)=>a-b);
    const first = dates[0];
    const last = dates[dates.length-1];
    const years = Math.max( (last - first) / (1000*60*60*24*365), 1/365 ); // at least one day
    const startVal = startCapital;
    const endVal = stats.equitySeries.length ? stats.equitySeries[stats.equitySeries.length-1] : startCapital;
    if(startVal > 0){
      cagr = Math.pow( endVal / startVal, 1/years ) - 1;
    }
  }
  stats.cagr = cagr;
  stats.expectancy = Number(stats.expectancy);
  return stats;
}

// render
function render(){
  rows.innerHTML = "";
  // apply active filters
  let filtered = trades.slice().sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
  if(activeFilters.asset) filtered = filtered.filter(t => t.asset.toLowerCase().includes(activeFilters.asset));
  if(activeFilters.from) filtered = filtered.filter(t => new Date(t.created_at) >= activeFilters.from);
  if(activeFilters.to) filtered = filtered.filter(t => new Date(t.created_at) <= new Date(activeFilters.to.getTime() + 24*60*60*1000 -1)); // include day

  // compute stats
  const startCapital = Number(startCapitalEl.value) > 0 ? Number(startCapitalEl.value) : 0;
  const stats = calcStats(filtered, startCapital);

  // populate rows (show newest first)
  filtered.slice().reverse().forEach(t=>{